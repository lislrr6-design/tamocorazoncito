<script>
const inicio=document.getElementById("inicio");
const zonaJuego=document.getElementById("zonaJuego");
const final=document.getElementById("final");
const gameOverDiv=document.getElementById("gameOver");
const musica=document.getElementById("musica");
const win=document.getElementById("win");
const mensajeJuego=document.getElementById("mensajeJuego");

const clickSound=document.getElementById("click");
const hitSound=document.getElementById("hit");
const gameoverSound=document.getElementById("gameoverSound");

function click(){ clickSound.play(); }

function huir(){
  no.style.left=Math.random()*80+"%";
  no.style.top=Math.random()*80+"%";
}

function aceptar(){
  inicio.style.display="none";
  zonaJuego.classList.remove("oculto");
  musica.volume=0.4;
  musica.play();
  iniciarJuego();
}

let m=0,p=0,s=0;
let msgM=false,msgP=false,msgS=false;
let vidas=3;

const vidasImg=document.querySelectorAll(".vida");
const mSpan=document.getElementById("m");
const pSpan=document.getElementById("p");
const sSpan=document.getElementById("s");
const personaje=document.getElementById("personaje");

/* ===== MOVIMIENTO CORREGIDO ===== */
let anchoPersonaje = personaje.offsetWidth;
let posX = (window.innerWidth - anchoPersonaje) / 2;
personaje.style.left = posX + "px";

let arrastrando=false;

personaje.addEventListener("pointerdown",e=>{
  arrastrando=true;
  personaje.setPointerCapture(e.pointerId);
});

document.addEventListener("pointermove",e=>{
  if(!arrastrando) return;

  let ancho = personaje.offsetWidth;
  posX = e.clientX - ancho/2;

  const margen = 15;
  posX = Math.max(
    margen,
    Math.min(window.innerWidth - ancho - margen, posX)
  );

  personaje.style.left = posX + "px";
});

document.addEventListener("pointerup",()=>arrastrando=false);

function mostrarMensaje(txt){
  mensajeJuego.innerHTML=txt;
  mensajeJuego.style.display="block";
  setTimeout(()=>mensajeJuego.style.display="none",2000);
}

let intervaloIconos;

function iniciarJuego(){
  intervaloIconos=setInterval(crearIcono,700);
}

function crearIcono(){
  const tipos=["mapache","pibble","spiderman","trampa1","trampa2","trampa3"];
  const tipo=tipos[Math.floor(Math.random()*tipos.length)];

  const img=document.createElement("img");
  img.className="icono";
  img.src="img/"+tipo+".png";

  if(tipo==="trampa3"){
    img.style.width="90px";
  }

  /* ===== ICONOS CON M√ÅRGENES ===== */
  const margen = window.innerWidth < 768 ? 50 : 0;
  img.style.left =
    margen +
    Math.random()*(window.innerWidth - 60 - margen*2) +
    "px";

  img.style.top="-60px";
  document.body.appendChild(img);

  let y=-60;
  let velocidad = window.innerWidth < 768 ? 6 : (tipo.includes("trampa") ? 7 : 4);

  const caer=setInterval(()=>{
    y+=velocidad;
    img.style.top=y+"px";

    const rI=img.getBoundingClientRect();
    const rP=personaje.getBoundingClientRect();

    /* ===== COLISI√ìN M√ÅS JUSTA ===== */
    if(
      rI.bottom >= rP.top + 15 &&
      rI.left < rP.right - 15 &&
      rI.right > rP.left + 15
    ){
      img.remove();
      clearInterval(caer);
      tipo.includes("trampa") ? perderVida() : atrapar(tipo);
    }

    if(y>window.innerHeight){
      img.remove();
      clearInterval(caer);
    }
  },20);
}

function atrapar(tipo){
  click();
  if(tipo==="mapache"&&m<3){ m++; if(m===3&&!msgM){ mostrarMensaje("Me encantas mi ni√±o lindo"); msgM=true; }}
  if(tipo==="pibble"&&p<3){ p++; if(p===3&&!msgP){ mostrarMensaje("üê∂ Te amo mil millones"); msgP=true; }}
  if(tipo==="spiderman"&&s<3){ s++; if(s===3&&!msgS){ mostrarMensaje("üï∑Ô∏è Eressh mi lugar seguro"); msgS=true; }}

  mSpan.innerText=m;
  pSpan.innerText=p;
  sSpan.innerText=s;

  if(m===3&&p===3&&s===3) ganar();
}

function perderVida(){
  hitSound.play();
  vidas--;
  vidasImg[vidas].style.display="none";
  if(vidas===0) gameOver();
}

function gameOver(){
  clearInterval(intervaloIconos);
  musica.pause();
  gameoverSound.play();
  gameOverDiv.classList.remove("oculto");
}

function reiniciarJuego(){
  gameOverDiv.classList.add("oculto");
  vidas=3;
  vidasImg.forEach(v=>v.style.display="inline");
  m=p=s=0;
  mSpan.innerText=pSpan.innerText=sSpan.innerText=0;
  musica.play();
  iniciarJuego();
}

function reiniciarDesdeFinal(){
  final.classList.add("oculto");
  zonaJuego.style.display="block";
  vidas=3;
  vidasImg.forEach(v=>v.style.display="inline");
  m=p=s=0;
  mSpan.innerText=pSpan.innerText=sSpan.innerText=0;
  msgM=msgP=msgS=false;
  musica.currentTime=0;
  musica.play();
  iniciarJuego();
}

function ganar(){
  clearInterval(intervaloIconos);
  zonaJuego.style.display="none";
  final.classList.remove("oculto");
  musica.pause();
  win.play();
}
</script>

</body>
</html>

